From 3c00c36addf672c3c242c43a45e4fa87c4613306 Mon Sep 17 00:00:00 2001
From: Constantin Konstantinidis <constantinkonstantinidis@gmail.com>
Date: Sun, 12 May 2024 08:52:35 +0200
Subject: [PATCH] cmd/go: return error when directory has no go.mod in module
 mode

---
 src/cmd/go/internal/modload/list.go        | 5 ++++-
 src/cmd/go/testdata/script/mod_enabled.txt | 2 +-
 src/cmd/go/testdata/script/mod_outside.txt | 2 +-
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/cmd/go/internal/modload/list.go b/src/cmd/go/internal/modload/list.go
index ef93c25121..422da933c8 100644
--- a/src/cmd/go/internal/modload/list.go
+++ b/src/cmd/go/internal/modload/list.go
@@ -131,7 +131,10 @@ func listModules(ctx context.Context, rs *Requirements, args []string, mode List
 			}
 			ms = append(ms, moduleInfo(ctx, rs, m, mode, reuse))
 		}
-		return rs, ms, nil
+		if !HasModRoot() {
+			mgErr = ErrNoModRoot
+		}
+		return rs, ms, mgErr
 	}
 
 	needFullGraph := false
diff --git a/src/cmd/go/testdata/script/mod_enabled.txt b/src/cmd/go/testdata/script/mod_enabled.txt
index 39f1ece8cb..31e98375ce 100644
--- a/src/cmd/go/testdata/script/mod_enabled.txt
+++ b/src/cmd/go/testdata/script/mod_enabled.txt
@@ -51,7 +51,7 @@ cd $GOPATH/src/x/y
 go env GOMOD
 stdout 'NUL|/dev/null'
 go list -m
-stdout '^command-line-arguments$'
+stderr '^go: go.mod file not found in current directory or any parent directory; see ''go help modules''$'
 
 cd $GOPATH/foo
 go env GOMOD
diff --git a/src/cmd/go/testdata/script/mod_outside.txt b/src/cmd/go/testdata/script/mod_outside.txt
index 7a0dc9f22f..098d88545c 100644
--- a/src/cmd/go/testdata/script/mod_outside.txt
+++ b/src/cmd/go/testdata/script/mod_outside.txt
@@ -14,7 +14,7 @@ stdout 'NUL|/dev/null'
 ! go list
 stderr '^go: go.mod file not found in current directory or any parent directory; see ''go help modules''$'
 go list -m
-stdout '^command-line-arguments$'
+stderr '^go: go.mod file not found in current directory or any parent directory; see ''go help modules''$'
 # 'go list' in the working directory should fail even if there is a a 'package
 # main' present: without a main module, we do not know its package path.
 ! go list ./needmod
-- 
2.43.0

